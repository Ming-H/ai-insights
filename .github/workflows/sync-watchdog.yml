name: Sync Watchdog

on:
  schedule:
    # Hourly health-check and self-heal
    - cron: '15 * * * *'
  workflow_dispatch:

permissions:
  contents: write
  actions: write

concurrency:
  group: sync-watchdog-${{ github.ref }}
  cancel-in-progress: false

jobs:
  watchdog:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout ai-insights
        uses: actions/checkout@v4
        with:
          path: ai-insights

      - name: Checkout content-forge-ai
        uses: actions/checkout@v4
        with:
          repository: Ming-H/content-forge-ai
          path: content-forge-ai
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Check sync health
        id: health
        run: |
          set -euo pipefail

          latest_digest=$(find "$GITHUB_WORKSPACE/content-forge-ai/data/daily" -type f -path "*/digest/digest_*.md" | sort | tail -1 || true)
          if [ -z "$latest_digest" ]; then
            echo "No digest found in source repository"
            echo "needs_sync=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          digest_name=$(basename "$latest_digest")
          date_ymd=$(echo "$digest_name" | sed -n 's/^digest_\([0-9]\{8\}\).*/\1/p')
          if [ -z "$date_ymd" ]; then
            echo "Unable to parse digest date from $digest_name"
            exit 1
          fi

          expected_file="${date_ymd:0:4}-${date_ymd:4:2}-${date_ymd:6:2}-index.md"
          target="$GITHUB_WORKSPACE/ai-insights/content/daily/$expected_file"

          echo "latest_digest=$latest_digest"
          echo "expected_target=$target"
          echo "expected_file=$expected_file" >> $GITHUB_OUTPUT

          if [ -f "$target" ]; then
            echo "Target already synced"
            echo "needs_sync=false" >> $GITHUB_OUTPUT
          else
            echo "Target file missing, sync required"
            echo "needs_sync=true" >> $GITHUB_OUTPUT
          fi

      - name: Run sync when lag is detected
        if: steps.health.outputs.needs_sync == 'true'
        run: |
          cd ai-insights
          export CONTENT_FORGE_AI_PATH="$GITHUB_WORKSPACE/content-forge-ai"
          export HUGO_CONTENT_PATH="$GITHUB_WORKSPACE/ai-insights/content"
          python scripts/sync_content.py --all

      - name: Commit and push recovery sync
        id: recovery-push
        if: steps.health.outputs.needs_sync == 'true'
        run: |
          set -euo pipefail
          cd ai-insights
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git add -A content/
          if git diff --cached --quiet; then
            echo "No changes after recovery sync"
            exit 0
          fi

          git commit -m "chore: watchdog recovery sync from content-forge-ai" \
                     -m "Recovered missing daily file: ${{ steps.health.outputs.expected_file }}" \
                     -m "Sync time: $(date '+%Y-%m-%d %H:%M:%S') (UTC)"

          pushed=false
          for attempt in 1 2 3; do
            echo "Push attempt $attempt/3"
            if git pull --rebase origin main && git push; then
              pushed=true
              break
            fi
            sleep 10
          done

          if [ "$pushed" != "true" ]; then
            echo "ERROR: watchdog recovery push failed"
            exit 1
          fi

          pushed_sha=$(git rev-parse HEAD)
          echo "pushed_sha=$pushed_sha" >> $GITHUB_OUTPUT
          remote_synced=false
          for attempt in 1 2 3 4 5 6 7 8 9 10 11 12; do
            echo "Wait remote main sync attempt $attempt/12"
            remote_sha=$(curl -sS \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer ${{ github.token }}" \
              https://api.github.com/repos/${{ github.repository }}/commits/main \
              | python -c 'import sys,json; print(json.load(sys.stdin).get("sha",""))')

            if [ "$remote_sha" = "$pushed_sha" ]; then
              remote_synced=true
              break
            fi

            sleep 5
          done

          if [ "$remote_synced" != "true" ]; then
            echo "ERROR: watchdog remote main did not catch up before deploy check"
            echo "Expected: $pushed_sha"
            echo "Actual:   $remote_sha"
            exit 1
          fi

      - name: Resolve target deploy SHA
        id: deploy-target
        run: |
          set -euo pipefail

          if [ "${{ steps.health.outputs.needs_sync }}" = "true" ] && [ -n "${{ steps.recovery-push.outputs.pushed_sha }}" ]; then
            target_sha="${{ steps.recovery-push.outputs.pushed_sha }}"
            echo "Using pushed SHA as deploy target: $target_sha"
          else
            target_sha=$(curl -sS \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer ${{ github.token }}" \
              https://api.github.com/repos/${{ github.repository }}/commits/main \
              | python -c 'import sys,json; print(json.load(sys.stdin).get("sha",""))')
            echo "Using current remote main SHA as deploy target: $target_sha"
          fi

          if [ -z "$target_sha" ]; then
            echo "ERROR: Unable to resolve deploy target SHA"
            exit 1
          fi

          echo "target_sha=$target_sha" >> $GITHUB_OUTPUT

      - name: Check Hugo deploy health
        id: deploy-health
        env:
          TARGET_SHA: ${{ steps.deploy-target.outputs.target_sha }}
        run: |
          set -euo pipefail

          runs_json=$(curl -sS \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ github.token }}" \
            "https://api.github.com/repos/${{ github.repository }}/actions/workflows/hugo.yml/runs?branch=main&per_page=30")

          runs_json_path=$(mktemp)
          printf '%s' "$runs_json" > "$runs_json_path"

          deploy_state=$(python - "$runs_json_path" <<'PY'
          import json
          import os
          import sys

          target_sha = os.environ.get("TARGET_SHA", "")
          state = "missing"

          if target_sha:
              with open(sys.argv[1], "r", encoding="utf-8") as fp:
                  data = json.load(fp)
              for run in data.get("workflow_runs", []):
                  if run.get("head_sha") != target_sha:
                      continue
                  status = run.get("status")
                  conclusion = run.get("conclusion")
                  if status in {"queued", "in_progress", "waiting", "requested", "pending"}:
                      state = "in_progress"
                      break
                  if status == "completed" and conclusion == "success":
                      state = "success"
                      break
                  if status == "completed":
                      state = "failed"
                      break

          print(state)
          PY
          )
          rm -f "$runs_json_path"

          echo "Deploy state for ${TARGET_SHA}: ${deploy_state}"
          echo "deploy_state=$deploy_state" >> $GITHUB_OUTPUT

          if [ "$deploy_state" = "success" ] || [ "$deploy_state" = "in_progress" ]; then
            echo "needs_dispatch=false" >> $GITHUB_OUTPUT
          else
            echo "needs_dispatch=true" >> $GITHUB_OUTPUT
          fi

      - name: Dispatch Hugo deploy when needed
        if: steps.deploy-health.outputs.needs_dispatch == 'true'
        run: |
          set -euo pipefail

          dispatched=false
          for attempt in 1 2 3; do
            echo "Dispatch Hugo deploy attempt $attempt/3"
            code=$(curl -s -o /tmp/hugo_dispatch_resp.json -w "%{http_code}" \
              -X POST \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer ${{ github.token }}" \
              https://api.github.com/repos/${{ github.repository }}/actions/workflows/hugo.yml/dispatches \
              -d '{"ref":"main"}')

            if [ "$code" = "204" ]; then
              dispatched=true
              break
            fi

            echo "Dispatch failed with HTTP $code"
            cat /tmp/hugo_dispatch_resp.json || true
            sleep 5
          done

          if [ "$dispatched" != "true" ]; then
            echo "ERROR: watchdog failed to dispatch Hugo deploy workflow"
            exit 1
          fi

      - name: Summary report
        if: always()
        run: |
          echo "========================================"
          echo "Watchdog Report"
          echo "========================================"
          echo "Time: $(TZ=Asia/Shanghai date '+%Y-%m-%d %H:%M:%S') (Beijing)"
          echo "Status: ${{ job.status }}"
          echo "Needs sync: ${{ steps.health.outputs.needs_sync }}"
          echo "Deploy target SHA: ${{ steps.deploy-target.outputs.target_sha }}"
          echo "Deploy state: ${{ steps.deploy-health.outputs.deploy_state }}"
          echo "Needs deploy dispatch: ${{ steps.deploy-health.outputs.needs_dispatch }}"
          echo "========================================"
